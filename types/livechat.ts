/**
 * Livechat Types - Tipos compostos específicos do Livechat
 */

import type {
  Contact,
  Conversation,
  Message,
  User,
} from './database';

// ============================================================================
// ENUMS
// ============================================================================

/**
 * Status de entrega da mensagem
 */
export type MessageStatus = 'pending' | 'sent' | 'failed' | 'read';

// ============================================================================
// COMPOSITE TYPES
// ============================================================================

/**
 * Contato com suas conversas ativas
 */
export interface ContactWithConversations extends Contact {
  activeConversations: ConversationWithLastMessage[];
}

/**
 * Conversa com última mensagem
 */
export interface ConversationWithLastMessage extends Conversation {
  lastMessage: Message | null;
}

/**
 * Conversa com dados do contato e última mensagem
 *
 * NOVO MODELO (2025-11-22): Cada card na UI representa uma CONVERSA (não um contato).
 * Mesmo contato pode ter múltiplos cards se tiver múltiplas conversas.
 *
 * Ver: docs/LIVECHAT_CONVERSATION_CARDS_REFACTOR.md
 */
export interface ConversationWithContact extends Conversation {
  contact: Pick<Contact, 'id' | 'name' | 'phone' | 'email' | 'status'>;
  lastMessage: Message | null;
}

/**
 * Mensagem com informações do remetente
 */
export interface MessageWithSender extends Message {
  senderUser?: Pick<User, 'id' | 'full_name' | 'avatar_url'> | null;
  status?: MessageStatus; // Status de entrega (adicionado na migration)
}

/**
 * Conversa completa com contato e mensagens
 */
export interface ConversationWithDetails extends Conversation {
  contact: Contact;
  messages: MessageWithSender[];
}

// ============================================================================
// API PAYLOADS
// ============================================================================

/**
 * Payload para enviar mensagem manual
 */
export interface SendMessagePayload {
  conversationId: string;
  content: string;
  tenantId: string;
}

/**
 * Payload para pausar IA
 */
export interface PauseIAPayload {
  conversationId: string;
  tenantId: string;
  reason?: string;
}

/**
 * Payload para retomar IA
 */
export interface ResumeIAPayload {
  conversationId: string;
  tenantId: string;
}

/**
 * Payload para usar quick reply
 */
export interface UseQuickReplyPayload {
  quickReplyId: string;
  conversationId: string;
  tenantId: string;
}

// ============================================================================
// FILTERS
// ============================================================================

/**
 * Filtros para listagem de contatos
 */
export interface ContactFilters {
  search?: string; // Busca por nome ou phone
  status?: Contact['status'];
  includeClosedConversations?: boolean; // Se true, inclui conversas encerradas na busca
  limit?: number;
  offset?: number;
}

/**
 * Filtros para listagem de conversas
 */
export interface ConversationFilters {
  search?: string; // Busca por nome ou phone do contato
  status?: Conversation['status']; // 'open' | 'paused' | 'closed'
  includeClosedConversations?: boolean; // Se true, inclui conversas encerradas
  limit?: number;
  offset?: number;
}

/**
 * Opções de ordenação da lista de contatos
 */
export interface ContactListSortOptions {
  sortBy: 'last_message' | 'name' | 'status';
  order: 'asc' | 'desc';
}

/**
 * Filtros para listagem de mensagens
 */
export interface MessageFilters {
  conversationId: string;
  limit?: number;
  before?: string; // timestamp
  after?: string; // timestamp
}

// ============================================================================
// UI STATE
// ============================================================================

/**
 * Estado de envio de mensagem
 */
export interface MessageSendState {
  isLoading: boolean;
  error: string | null;
}

/**
 * Estado de controles da conversa
 */
export interface ConversationControlsState {
  isPausingIA: boolean;
  isResumingIA: boolean;
  error: string | null;
}

// ============================================================================
// QUICK REPLIES
// ============================================================================

/**
 * Quick Reply do tenant
 */
export interface QuickReply {
  id: string;
  tenant_id: string;
  title: string;
  message: string;
  icon: string | null;
  usage_count: number;
  created_at: string;
  updated_at: string;
}

/**
 * Payload para criar quick reply
 */
export interface QuickReplyCreatePayload {
  title: string;
  message: string;
  icon?: string;
  tenantId: string;
}

/**
 * Payload para incrementar uso de quick reply
 */
export interface QuickReplyUsagePayload {
  quickReplyId: string;
  tenantId: string;
}

// ============================================================================
// MESSAGE FEEDBACK
// ============================================================================

/**
 * Feedback de mensagem da IA
 */
export interface MessageFeedback {
  id: string;
  tenant_id: string;
  message_id: string;
  conversation_id: string;
  rating: 'positive' | 'negative';
  comment: string | null;
  user_id: string;
  created_at: string;
}

/**
 * Payload para criar feedback
 */
export interface MessageFeedbackPayload {
  messageId: string;
  conversationId: string;
  rating: 'positive' | 'negative';
  comment?: string;
  tenantId: string;
}

// ============================================================================
// CONTACT DATA
// ============================================================================

/**
 * Histórico de alteração de dados do contato
 */
export interface ContactDataChange {
  id: string;
  tenant_id: string;
  contact_id: string;
  field_name: string;
  old_value: string | null;
  new_value: string | null;
  changed_by: string;
  changed_at: string;
}

/**
 * Payload para atualizar campo do contato (update de campo único)
 */
export interface ContactUpdatePayload {
  contactId: string;
  field: string;
  value: unknown;
  tenantId: string;
}

/**
 * Payload para atualizar múltiplos campos do contato
 */
export interface ContactBulkUpdatePayload {
  name: string;
  email?: string | null;
  cpf?: string | null;
  phone_secondary?: string | null;
  address_street?: string | null;
  address_number?: string | null;
  address_complement?: string | null;
  city?: string | null;
  zip_code?: string | null;
}
